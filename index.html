<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>powerd++: Main Page</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">powerd++
   &#160;<span id="projectnumber">0.4.2+c9</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">powerd++ Documentation</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="fragment"><div class="line">                                      /\  __</div>
<div class="line">   __ __ ___  ___  __ _____  ___  ___/ /_/ /_</div>
<div class="line">  /_//_//   \/   \/ // / _ \/ __\/    /_   _/__</div>
<div class="line"> __ __ / // / // /    / ___/ /  / // /  /_/_/ /_</div>
<div class="line">/_//_// ___/\___/\_/_/\___/_/   \___/     /_  _/</div>
<div class="line">     / /                                   /_/</div>
<div class="line">     \/ multi-core CPU clock daemon for FreeBSDÂ®</div>
</div><!-- fragment --><p>The powerd++ daemon is a drop-in replacement for FreeBSD's native powerd. Its purpose is to reduce the energy consumption of CPUs for the following benefits:</p>
<ul>
<li>Avoid unnecessary fan noise from portable devices</li>
<li>Improve the battery runtime of portable devices</li>
<li>Improve hardware lifetime by reducing thermal stress</li>
<li>Energy conservation</li>
</ul>
<p><b>Contents</b></p>
<ol type="1">
<li><a href="#md_README_using-powerd">Using powerd++</a><ol type="a">
<li><a href="#md_README_packages">Packages</a></li>
<li><a href="#md_README_running-powerd">Running powerd++</a></li>
<li><a href="#md_README_manuals">Manuals</a></li>
<li><a href="#md_README_tuning">Tuning</a></li>
<li><a href="#md_README_reporting-issues-requesting-features">Reporting Issues / Requesting Features</a></li>
</ol>
</li>
<li><a href="#md_README_buildinginstalling">Building/Installing</a><ol type="a">
<li><a href="#md_README_building">Building</a></li>
<li><a href="#md_README_installing">Installing</a></li>
<li><a href="#md_README_documentation">Documentation</a></li>
</ol>
</li>
<li><a href="#md_README_development">Development</a><ol type="a">
<li><a href="#md_README_design">Design</a></li>
<li><a href="#md_README_license">License</a></li>
</ol>
</li>
</ol>
<h1><a class="anchor" id="md_README_using-powerd"></a>
Using powerd++</h1>
<p>Powerd++ offers the following features:</p>
<ul>
<li>Load target based clock frequency control</li>
<li>Tunable sampling with moving average filter</li>
<li>Load recording and replay tooling for benchmarking, tuning and reporting issues</li>
<li>Command line compatibility with <a href="https://www.freebsd.org/cgi/man.cgi?query=powerd">powerd(8)</a></li>
<li>Temperature based throttling</li>
<li>Expressive command line arguments with units, ranges and argument chaining</li>
<li>Helpful error messages</li>
<li>Comprehensive manual pages</li>
</ul>
<h2><a class="anchor" id="md_README_packages"></a>
Packages</h2>
<p>The <a href="https://www.freebsd.org/">FreeBSD</a> port is <code>sysutils/powerdxx</code>, the package name <code>powerdxx</code>.</p>
<h2><a class="anchor" id="md_README_running-powerd"></a>
Running powerd++</h2>
<p>It is not intended to run powerd++ simultaneously with powerd. To prevent this powerd++ uses the same default pidfile as powerd:</p>
<div class="fragment"><div class="line"># service powerdxx onestart</div>
<div class="line">Starting powerdxx.</div>
<div class="line">powerd++: (ECONFLICT) a power daemon is already running under PID: 59866</div>
<div class="line">/usr/local/etc/rc.d/powerdxx: WARNING: failed to start powerdxx</div>
</div><!-- fragment --><p>So if powerd is already setup, it first needs to be disabled:</p>
<div class="fragment"><div class="line"># service powerd stop</div>
<div class="line">Stopping powerd.</div>
<div class="line">Waiting for PIDS: 50127.</div>
<div class="line"># service powerd disable</div>
<div class="line">powerd disabled in /etc/rc.conf</div>
</div><!-- fragment --><p>Afterwards powerd++ can be enabled:</p>
<div class="fragment"><div class="line"># service powerdxx enable</div>
<div class="line">powerdxx enabled in /etc/rc.conf</div>
<div class="line"># service powerdxx start</div>
<div class="line">Starting powerdxx.</div>
</div><!-- fragment --><h2><a class="anchor" id="md_README_manuals"></a>
Manuals</h2>
<p>Comprehensive manual pages exist for powerd++ and its accompanying tools loadrec and loadplay:</p>
<div class="fragment"><div class="line">&gt; man powerd++ loadrec loadplay</div>
</div><!-- fragment --><p>The current version of the manual pages may be read directly from the repository:</p>
<div class="fragment"><div class="line">&gt; man man/*</div>
</div><!-- fragment --><p>The manual pages as of the last release can also be <a href="https://lonkamikaze.github.io/powerdxx/pages.html">read online</a>.</p>
<h2><a class="anchor" id="md_README_tuning"></a>
Tuning</h2>
<p>Three parameters affect the responsiveness of powerd++:</p>
<ul>
<li>The load target (refer to <code>-a</code>, <code>-b</code> and <code>-n</code>)</li>
<li>The polling interval (refer to <code>-p</code>)</li>
<li>The sample count (refer to <code>-s</code>)</li>
</ul>
<p>The key to tuning powerd++ is the <code>-f</code> flag, which keeps powerd++ in foreground and causes it to report its activity. This allows directly observing the effects of a parameter set.</p>
<p>Observing the defaults in action may be a good start:</p>
<div class="fragment"><div class="line"># powerd++ -f</div>
<div class="line">power:  online, load:  693 MHz,  42 C, cpu.0.freq: 2401 MHz, wanted: 1848 MHz</div>
<div class="line">power:  online, load:  475 MHz,  43 C, cpu.0.freq: 1800 MHz, wanted: 1266 MHz</div>
<div class="line">power:  online, load:  271 MHz,  43 C, cpu.0.freq: 1300 MHz, wanted:  722 MHz</div>
<div class="line">power:  online, load:   64 MHz,  43 C, cpu.0.freq:  768 MHz, wanted:  170 MHz</div>
<div class="line">power:  online, load:   55 MHz,  42 C, cpu.0.freq:  768 MHz, wanted:  146 MHz</div>
<div class="line">power:  online, load:   57 MHz,  42 C, cpu.0.freq:  768 MHz, wanted:  152 MHz</div>
<div class="line">power:  online, load:   60 MHz,  44 C, cpu.0.freq:  768 MHz, wanted:  160 MHz</div>
<div class="line">power:  online, load:   67 MHz,  42 C, cpu.0.freq:  768 MHz, wanted:  178 MHz</div>
<div class="line">...</div>
</div><!-- fragment --><p>Note, the immediate high load is due to the load buffer being filled under the assumption that the past load fits the current clock frequency when powerd++ starts.</p>
<h2><a class="anchor" id="md_README_reporting-issues-requesting-features"></a>
Reporting Issues / Requesting Features</h2>
<p>Please report issues and feature requests on <a href="https://github.com/lonkamikaze/powerdxx/issues">GitHub</a> or to <a href="#" onclick="location.href='mai'+'lto:'+'kam'+'ik'+'aze'+'@b'+'sdf'+'or'+'en.'+'de'; return false;">kamik<span style="display: none;">.nosp@m.</span>aze@<span style="display: none;">.nosp@m.</span>bsdfo<span style="display: none;">.nosp@m.</span>ren.<span style="display: none;">.nosp@m.</span>de</a>.</p>
<p>If powerd++ behaves in some unexpected or undesired manner, please mention all the command line flags (e.g. from <code>/etc/rc.conf</code> <code>powerdxx_flags</code>) and provide a load recording:</p>
<div class="fragment"><div class="line">&gt; loadrec -o myissue.load</div>
</div><!-- fragment --><p>The default recording duration is 30 s. Do not omit the <code>-o</code> parameter, printing the output on the terminal may create significant load and impact the recorded load significantly.</p>
<p>Before submitting the report, try to reproduce the behaviour using the recorded load:</p>
<div class="fragment"><div class="line">&gt; loadplay -i myissue.load -o /dev/null powerd++ -f</div>
<div class="line">power:  online, load:  224 MHz, cpu.0.freq:  768 MHz, wanted:  597 MHz</div>
<div class="line">power:  online, load:  155 MHz, cpu.0.freq:  768 MHz, wanted:  413 MHz</div>
<div class="line">power:  online, load:   85 MHz, cpu.0.freq:  768 MHz, wanted:  226 MHz</div>
<div class="line">power:  online, load:   29 MHz, cpu.0.freq:  768 MHz, wanted:   77 MHz</div>
<div class="line">power:  online, load:   23 MHz, cpu.0.freq:  768 MHz, wanted:   61 MHz</div>
<div class="line">...</div>
</div><!-- fragment --><h1><a class="anchor" id="md_README_buildinginstalling"></a>
Building/Installing</h1>
<p>The <code>Makefile</code> offers a set of targets, it is written for FreeBSD's <a href="https://www.freebsd.org/cgi/man.cgi?query=make">make(1)</a>:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Target  </th><th class="markdownTableHeadNone">Description   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">all  </td><td class="markdownTableBodyNone">Build everything   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">debug  </td><td class="markdownTableBodyNone">Build with <code>CXXFLAGS=-O0 -g -DEBUG</code>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">paranoid  </td><td class="markdownTableBodyNone">Turn on undefined behaviour canaries   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">install  </td><td class="markdownTableBodyNone">Install tools and manuals   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">deinstall  </td><td class="markdownTableBodyNone">Deinstall tools and manuals   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">clean  </td><td class="markdownTableBodyNone">Clear build directory <code>obj/</code>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">doc  </td><td class="markdownTableBodyNone">Build HTML documentation   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">gh-pages  </td><td class="markdownTableBodyNone">Build and publish HTML and PDF documentation   </td></tr>
</table>
<h2><a class="anchor" id="md_README_building"></a>
Building</h2>
<p>The <code>all</code> target is the default target that is called implicitly if make is run without arguments:</p>
<div class="fragment"><div class="line">&gt; make</div>
<div class="line">c++  -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic -c src/powerd++.cpp -o powerd++.o</div>
<div class="line">c++  -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic -c src/clas.cpp -o clas.o</div>
<div class="line">c++ -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic powerd++.o clas.o -lutil -o powerd++</div>
<div class="line">c++  -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic -c src/loadrec.cpp -o loadrec.o</div>
<div class="line">c++ -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic loadrec.o clas.o -o loadrec</div>
<div class="line">c++  -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic -c src/loadplay.cpp -o loadplay.o</div>
<div class="line">c++ -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic loadplay.o clas.o -o loadplay</div>
<div class="line">c++ -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic -fPIC -c src/libloadplay.cpp -o libloadplay.o</div>
<div class="line">c++ -O2 -pipe -march=haswell  -std=c++17 -Wall -Werror -pedantic libloadplay.o -lpthread -shared -o libloadplay.so</div>
<div class="line">&gt;</div>
</div><!-- fragment --><p>The <code>debug</code> and <code>paranoid</code> flags perform the same build as the <code>all</code> target, but with different/additional <code>CXXFLAGS</code>. The <code>debug</code> and <code>paranoid</code> targets can be combined.</p>
<h2><a class="anchor" id="md_README_installing"></a>
Installing</h2>
<p>The installer installs the tools and manual pages according to a recipe in <code>pkg/files</code>. The following variables can be passed to <code>make install</code> or <code>make deinstall</code> to affect the install destination:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Variable  </th><th class="markdownTableHeadNone">Default   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>DESTDIR</code>  </td><td class="markdownTableBodyNone"></td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>PREFIX</code>  </td><td class="markdownTableBodyNone"><code>/usr/local</code>   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>DOCSDIR</code>  </td><td class="markdownTableBodyNone"><code>${PREFIX}/share/doc/powerdxx</code>   </td></tr>
</table>
<p><code>DESTDIR</code> can be used to install powerd++ into a chroot or jail, e.g. to put it into the staging area when building a package using the FreeBSD ports. Unlike <code>PREFIX</code> and <code>DOCSDIR</code> it does not affect the installed files themselves.</p>
<h2><a class="anchor" id="md_README_documentation"></a>
Documentation</h2>
<p>Building the documentation requires <code>doxygen</code> 1.8.15 or later, building the PDF version of the documentation requires <code>xelatex</code> as provided by the tex-xetex package.</p>
<p>The <code>doc</code> target populates <code>doc/html</code> and <code>doc/latex</code>, to create the PDF documentation <code>doc/latex/refman.pdf</code> must be built.</p>
<p>The <code>gh-pages</code> target builds the HTML and PDF documentation and drops it into the <code>gh-pages</code> submodule for publishing on <a href="https://lonkamikaze.github.io/powerdxx">github.io</a>.</p>
<h1><a class="anchor" id="md_README_development"></a>
Development</h1>
<p>The following table provides an overview of repository contents:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">File/Folder  </th><th class="markdownTableHeadNone">Contents   </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>doc/</code>  </td><td class="markdownTableBodyNone">Output directory for doxygen documentation   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>doxy/</code>  </td><td class="markdownTableBodyNone">Doxygen configuration and filter scripts   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>gh-pages/</code>  </td><td class="markdownTableBodyNone">Submodule for publishing the documentation   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>man/</code>  </td><td class="markdownTableBodyNone">Manual pages written using mdoc(7) markup   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>obj/</code>  </td><td class="markdownTableBodyNone">Build output   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>pkg/</code>  </td><td class="markdownTableBodyNone">Installer scripts and instructions   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>src/</code>  </td><td class="markdownTableBodyNone">C++ source files   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>src/sys/</code>  </td><td class="markdownTableBodyNone">C++ wrappers for common C interfaces   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>powerd++.rc</code>  </td><td class="markdownTableBodyNone">Init script / service description   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>LICENSE.md</code>  </td><td class="markdownTableBodyNone">ISC license   </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone"><code>Makefile</code>  </td><td class="markdownTableBodyNone">Build instructions   </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone"><code>README.md</code>  </td><td class="markdownTableBodyNone">Project overview   </td></tr>
</table>
<h2><a class="anchor" id="md_README_design"></a>
Design</h2>
<p>The life cycle of the powerd++ process goes through three stages:</p>
<ol type="1">
<li>Command line argument parsing</li>
<li>Initialisation and optionally printing the detected/configured parameters</li>
<li>Clock frequency control</li>
</ol>
<p>The first stage is designed to maximise usability by providing both, the compact short option syntax (e.g. <code>-vfbhadp</code>) as well as the more self-descriptive long option syntax (e.g. <code>--verbose --foreground --batt hiadaptive</code>).</p>
<p>The second stage is designed to trigger all known error conditions in order to fail before calling daemon(3) at the start of the third stage. Both the first and second stage are meant to provide specific, helpful error messages.</p>
<p>The third stage tracks the CPU load and performs clock frequency control. It is designed to provide its functionality with as little runtime as possible. This is achieved by:</p>
<ul>
<li>Using integer arithmetic only</li>
<li>Minimising branching</li>
</ul>
<p>The latter is achieved by using function templates to roll out possible runtime state combinations as multiple functions. A single, central switch/case selects the correct function each cycle. This basically rolls out multiple code paths through a single function into multiple functions with a single code path.</p>
<p>The trade-off made is for runtime over code size. With every bit of state rolled out like this the number of functions that need to be generated doubles, thus this approach is limited to the few bits of state that control the most expensive functionality, e.g. the foreground mode.</p>
<h2><a class="anchor" id="md_README_license"></a>
License</h2>
<p>This project is published under the <a class="el" href="md_LICENSE.html">ISC license</a>. </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
